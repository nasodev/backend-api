# ============================================
# 프로덕션 환경용 Docker Compose 설정
# ============================================
# 사용법: docker compose -f docker-compose.prod.yml up -d
# 중지: docker compose -f docker-compose.prod.yml down
# 로그 확인: docker compose -f docker-compose.prod.yml logs -f
#
# 사전 준비:
# 1. docker network create funq-network
# 2. /home/funq/dev/config/backend-api/.env.prod 파일 생성
# 3. Firebase 인증 파일 복사

services:
  # ============================================
  # backend-api 서비스 (FastAPI 애플리케이션)
  # ============================================
  backend-api:
    # GHCR에서 이미지 가져오기 (GitHub Actions에서 빌드/푸시된 이미지)
    # ${IMAGE_TAG:-latest}: 환경변수로 태그 지정 가능, 기본값은 latest
    # 롤백 시: export IMAGE_TAG=이전태그 후 재시작
    image: ghcr.io/nasodev/backend-api:${IMAGE_TAG:-latest}

    # 컨테이너 이름
    container_name: backend-api

    # 포트 매핑
    # "127.0.0.1:8000:8000" = 로컬호스트에서만 접근 가능
    # 외부에서 직접 접근 불가 → Nginx가 프록시로 처리
    # (Nginx → localhost:8000 → 컨테이너:8000)
    ports:
      - "127.0.0.1:8000:8000"

    # 볼륨 마운트
    # 프로덕션에서는 최소한의 파일만 마운트
    volumes:
      # Alembic 마이그레이션 파일 (git에서 관리)
      - ./alembic:/app/alembic:ro
      - ./alembic.ini:/app/alembic.ini:ro
      # Firebase 인증 파일 (서버의 config 디렉토리에서)
      - /home/funq/dev/config/backend-api/firebase:/app/firebase:ro

    # 환경 변수 파일
    # 민감한 정보(DB 비밀번호, API 키 등)는 별도 파일로 관리
    # 이 파일은 git에 올리지 않음
    env_file:
      - /home/funq/dev/config/backend-api/.env.prod

    # 추가 환경 변수 (env_file보다 우선)
    environment:
      - DEBUG=false

    # 네트워크: postgres와 같은 네트워크에 연결
    networks:
      - funq-network

    # 재시작 정책
    restart: unless-stopped

    # 헬스체크
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # ============================================
    # 리소스 제한 (프로덕션 안정성)
    # ============================================
    deploy:
      resources:
        # 최대 사용량 제한
        limits:
          cpus: '1.0'         # CPU 1코어까지
          memory: 512M        # 메모리 512MB까지
        # 최소 보장 리소스
        reservations:
          cpus: '0.25'        # CPU 0.25코어 보장
          memory: 128M        # 메모리 128MB 보장

    # ============================================
    # 로깅 설정
    # ============================================
    logging:
      driver: "json-file"     # JSON 형식으로 로그 저장
      options:
        max-size: "10m"       # 로그 파일 최대 10MB
        max-file: "3"         # 최대 3개 파일 유지 (총 30MB)
                              # 오래된 로그는 자동 삭제

# ============================================
# 네트워크 설정
# ============================================
networks:
  funq-network:
    name: funq-network
    external: true            # 기존에 생성된 네트워크 사용
                              # postgres 컨테이너도 이 네트워크에 연결되어 있어야 함
                              # 연결 확인: docker network inspect funq-network
