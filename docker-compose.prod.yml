# ============================================
# 프로덕션 환경용 Docker Compose 설정
# ============================================
# 사용법: docker compose -f docker-compose.prod.yml up -d
# 중지: docker compose -f docker-compose.prod.yml down
# 로그 확인: docker compose -f docker-compose.prod.yml logs -f
#
# 사전 준비:
# 1. docker network create funq-network
# 2. /home/funq/dev/config/backend-api/.env.prod 파일 생성
# 3. /home/funq/dev/config/backend-api/firebase/ 에 인증 파일 복사

services:
  # ============================================
  # backend-api 서비스 (FastAPI 애플리케이션)
  # ============================================
  backend-api:
    # GHCR에서 이미지 가져오기 (GitHub Actions에서 빌드/푸시된 이미지)
    # ${IMAGE_TAG:-latest}: 환경변수로 태그 지정 가능, 기본값은 latest
    # 롤백 시: export IMAGE_TAG=이전태그 후 재시작
    image: ghcr.io/nasodev/backend-api:${IMAGE_TAG:-latest}

    # 컨테이너 이름
    container_name: backend-api

    # 포트 매핑
    # "127.0.0.1:8000:8000" = 로컬호스트에서만 접근 가능
    # 외부에서 직접 접근 불가 → Nginx가 프록시로 처리
    ports:
      - "127.0.0.1:8000:8000"

    # 볼륨 마운트 (프로덕션에서는 최소한의 파일만)
    volumes:
      - ./alembic:/app/alembic:ro          # DB 마이그레이션 파일
      - ./alembic.ini:/app/alembic.ini:ro  # Alembic 설정
      - /home/funq/dev/config/backend-api/firebase:/app/firebase:ro  # Firebase 인증 파일
      - /home/funq/.claude:/home/appuser/.claude  # Claude CLI 로그인 정보

    # 환경 변수 파일 (민감 정보는 별도 파일로 관리, git 제외)
    env_file:
      - /home/funq/dev/config/backend-api/.env.prod

    # 추가 환경 변수 (env_file보다 우선)
    environment:
      - DEBUG=false

    # 네트워크: postgres와 같은 네트워크에 연결
    networks:
      - funq-network

    # 재시작 정책
    restart: unless-stopped

    # 헬스체크
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # ============================================
    # 리소스 제한 (프로덕션 안정성)
    # ============================================
    deploy:
      resources:
        limits:
          cpus: '1.0'         # CPU 1코어까지
          memory: 512M        # 메모리 512MB까지
        reservations:
          cpus: '0.25'        # CPU 0.25코어 보장
          memory: 128M        # 메모리 128MB 보장

    # ============================================
    # 로깅 설정
    # ============================================
    logging:
      driver: "json-file"
      options:
        max-size: "10m"       # 로그 파일 최대 10MB
        max-file: "3"         # 최대 3개 파일 유지 (총 30MB)

# ============================================
# 네트워크 설정
# ============================================
networks:
  funq-network:
    name: funq-network
    external: true            # 기존에 생성된 네트워크 사용
